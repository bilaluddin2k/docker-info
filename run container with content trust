---
- name: Deploy Docker containers with extra parameters
  hosts: localhost
  become: true
  vars:
    container_count: 3  # Number of containers to create
    env: "production"  # Set your environment variable
  tasks:
    - name: Set DOCKER_CONTENT_TRUST to 0
      community.general.environment:
        env_vars:
          DOCKER_CONTENT_TRUST: 0

    - name: Create Docker containers
      community.docker.docker_container:
        name: "complete-scd-{{ item }}"
        image: "sbi-ckyc-downloader.signzy.tech/ckyc-worker-oracle:v3.0.30"
        state: started
        detach: true
        network_mode: host
        add_hosts:
          - "SP3SIGNZYAPP26PROD:10.191.144.45"
          - "SP3SIGNZYWEB1PROD:10.189.250.51"
        security_opts:
          - "no-new-privileges"
          - "apparmor=docker-default"
        restart_policy: "on-failure"
        restart_retries: 5
        healthcheck:
          test: ["CMD", "stat", "/etc/passwd"]
          interval: "30s"
          retries: 3
        memory: "4096m"
        cpu_shares: 819
        pids_limit: 100
        volumes:
          - "/docker/bind-volumes/worker-volume:/app/ckyc-worker/tmp"
        env:
          env: "{{ env }}"
          no_proxy: "localhost,127.0.0.1,10.189.250.51,10.189.250.52,10.189.250.53,10.189.250.54,10.189.250.55,10.191.144.20,10.191.144.21,10.191.144.22,10.191.144.23,10.191.144.24,10.191.144.25,10.191.144.26,10.191.144.27,10.191.144.28,10.191.144.29,10.191.144.30,10.191.144.31,10.191.144.32,10.191.144.33,10.191.144.34,10.191.144.35,10.191.144.36,10.191.144.37,10.191.144.38,10.191.144.39,10.191.144.40,10.191.144.41,10.191.144.42,10.191.144.43,10.191.144.44,10.191.144.45,SP3SIGNZYAPP1PROD,SP3SIGNZYAPP2PROD,SP3SIGNZYAPP3PROD,SP3SIGNZYAPP4PROD,SP3SIGNZYAPP5PROD,SP3SIGNZYAPP6PROD,SP3SIGNZYAPP7PROD,SP3SIGNZYAPP8PROD,SP3SIGNZYAPP9PROD,SP3SIGNZYAPP10PROD,SP3SIGNZYAPP11PROD,SP3SIGNZYAPP12PROD,SP3SIGNZYAPP13PROD,SP3SIGNZYAPP14PROD,SP3SIGNZYAPP15PROD,SP3SIGNZYAPP16PROD,SP3SIGNZYAPP17PROD,SP3SIGNZYAPP18PROD,SP3SIGNZYAPP19PROD,SP3SIGNZYAPP20PROD,SP3SIGNZYAPP21PROD,SP3SIGNZYAPP22PROD,SP3SIGNZYAPP23PROD,SP3SIGNZYAPP24PROD,SP3SIGNZYAPP25PROD,SP3SIGNZYAPP26PROD,10.189.197.158,10.189.197.159,10.189.197.160,SP3SIGNZYDB1DBPROD,SP3SIGNZYDB2DBPROD,SP3SIGNZYDB3DBPROD"
          NO_PROXY: "localhost,127.0.0.1,10.189.250.51,10.189.250.52,10.189.250.53,10.189.250.54,10.189.250.55,10.191.144.20,10.191.144.21,10.191.144.22,10.191.144.23,10.191.144.24,10.191.144.25,10.191.144.26,10.191.144.27,10.191.144.28,10.191.144.29,10.191.144.30,10.191.144.31,10.191.144.32,10.191.144.33,10.191.144.34,10.191.144.35,10.191.144.36,10.191.144.37,10.191.144.38,10.191.144.39,10.191.144.40,10.191.144.41,10.191.144.42,10.191.144.43,10.191.144.44,10.191.144.45,SP3SIGNZYAPP1PROD,SP3SIGNZYAPP2PROD,SP3SIGNZYAPP3PROD,SP3SIGNZYAPP4PROD,SP3SIGNZYAPP5PROD,SP3SIGNZYAPP6PROD,SP3SIGNZYAPP7PROD,SP3SIGNZYAPP8PROD,SP3SIGNZYAPP9PROD,SP3SIGNZYAPP10PROD,SP3SIGNZYAPP11PROD,SP3SIGNZYAPP12PROD,SP3SIGNZYAPP13PROD,SP3SIGNZYAPP14PROD,SP3SIGNZYAPP15PROD,SP3SIGNZYAPP16PROD,SP3SIGNZYAPP17PROD,SP3SIGNZYAPP18PROD,SP3SIGNZYAPP19PROD,SP3SIGNZYAPP20PROD,SP3SIGNZYAPP21PROD,SP3SIGNZYAPP22PROD,SP3SIGNZYAPP23PROD,SP3SIGNZYAPP24PROD,SP3SIGNZYAPP25PROD,SP3SIGNZYAPP26PROD,10.189.197.158,10.189.197.159,10.189.197.160,SP3SIGNZYDB1DBPROD,SP3SIGNZYDB2DBPROD,SP3SIGNZYDB3DBPROD"
        command: "/bin/bash -c 'cd /app/ckyc-worker; python3 consume.py'"
      loop: "{{ range(1, container_count + 1) | list }}"